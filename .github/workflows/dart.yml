name: Windows Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable long file paths (Windows)
        run: git config --system core.longpaths true

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          architecture: x64

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Show tool versions
        run: |
          flutter --version
          dart --version
          rustc --version
          cargo --version

      - name: Cache Cargo artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache Dart pub cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ env.LOCALAPPDATA }}\Pub\Cache
          key: ${{ runner.os }}-pub-${{ hashFiles('client/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Enable Windows desktop
        run: flutter config --no-analytics --enable-windows-desktop

      - name: Pre-cache Windows artifacts
        run: flutter precache --windows

      - name: Install flutter_rust_bridge_codegen
        run: |
          dart pub global activate --source git https://github.com/fzyzcjy/flutter_rust_bridge.git --git-ref v2.11.1 --path frb_codegen

      - name: Add Dart pub bin to PATH
        run: |
          "${env:LOCALAPPDATA}\Pub\Cache\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Generate rust_builder (Cargokit)
        working-directory: client
        run: flutter_rust_bridge_codegen --config flutter_rust_bridge.yaml --cargokit-out rust_builder

      - name: Fetch Dart/Flutter dependencies
        working-directory: client
        run: flutter pub get

      - name: Build Rust library (Release)
        working-directory: rust
        run: cargo build -p rust_lib_application --release --verbose

      - name: Build Windows app (Release)
        working-directory: client
        env:
          RUST_BACKTRACE: 1
        run: flutter build windows --release

      - name: Archive Windows build output
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: client/build/windows/x64/runner/Release/
          if-no-files-found: warn